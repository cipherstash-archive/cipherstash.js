# Stash.JS TypeORM Demo

This is a very simple Node.js app that uses TypeORM and the CipherStash Stash.JS integration,
`stashjs-typeorm`.
It encrypts sensitive fields and queryable encrypted indexes to those fields.
Together this is called Queryable Application Level Encryption (QuALE).

## Helpful Links

* [TypeORM](https://typeorm.io)
* [CipherStash Docs](https://docs.cipherstash.com)
* [stashjs-typeorm on NPM](https://www.npmjs.com/package/@cipherstash/stashjs-typeorm)

## Prerequistites

To get started, you will need a PostgreSQL database
(although you can change it to use any TypeORM supported option by editing `src/data-source.ts`).

You will also need Node.js 15 or later.

## Installing

```sh
npm install
```

Edit the `src/data-source.ts` file and set your database credentials
as appropriate to your system:

```typescript
export const AppDataSource = new DataSource({
  // ** Change these to suit your system **
  type: "postgres",
  host: "localhost",
  port: 5432,
  username: "dan",
  database: "stashjs_typeorm_demo",
  ...
})
```

Create a database (assuming you stick with PostgreSQL):

```
createdb stashjs_typeorm_demo
```

## Run the Demo

The main demo code lives in `src/index.ts`.
You can run it with:

```sh
npm start
```

The demo will create 100 random users, automatically save them
into the data-base and encrypt them.

It then runs 3 different queries as examples to demonstrate CipherStash's queryable
encryption capabilities.

These are:

* All users ordered by `firstName`
* Partial string match on `lastName`
* A complex query combining partial string match and a range query on `dob` with results ordered by `dob`.

## Inspecting the data

The demo deletes the data after all queries have been run but if you want to inspect the database
or run some of your own queries you can can comment out the `demoTeardown()` line at the end.

```typescript
// -- src/index.ts --

// Comment this line if you want to play around
await demoTeardown()
```

## Demo Dissected

Let's break down what's in this demo.

### User Entity

We define a User Entity model in `src/entity/User.ts`

It looks like this:

```typescript
import { Entity, PrimaryGeneratedColumn, Column } from "typeorm"
import { EncryptedColumn, Queryable } from "@cipherstash/stashjs-typeorm"

import { key } from "../config"

@Entity({ name: "node_users" })
export class User {
  @PrimaryGeneratedColumn()
  id: number

  @Queryable()
  @EncryptedColumn({ key })
  firstName: string

  @Queryable()
  @EncryptedColumn({ key })
  lastName: string

  // Dates must be treated as timestamps in TypeORM 
  // See this issue: https://github.com/typeorm/typeorm/issues/2176
  @Queryable()
  @Column({type: "timestamp"})
  dob: Date

  // Could this be added with a class decorator
  @Column({ nullable: true })
  stashId: string
}
```

The user model is pretty simple:

* `firstName`, `lastName` and `dob` fields
* Autogenerated numeric `id` for the primary key
* `stashId` string (UUID) field for linking to CipherStash

`stashjs-typeorm` adds two additional decorators:

* `EncryptedColumn` specifies that a field should be encrypted
* `Queryable` specifies that a field is queryable via CipherStash

### Encrypted Column

Fields encrypted with `@EncryptedColumn` are encrypted directly in the PostgreSQL database using AES-256-GCM.

`EncryptedColumn` *wraps* TypeORM's `Column` decorator so both can't be used
on the same field.


```typescript
  // ** WRONG **
  @EncryptedColumn({ key })
  @Column()
  firstName: string

  // Do this (EncryptedColumn is a superset of Column)
  @EncryptedColumn({ key })
  firstName: string
```

`EncryptedColumn` takes all the same options as `Column` except that it **must be provided a key**.

### Queryable

The `@Queryable` decorator adds queryable encryption to a field via a CipherStash index.
`stashjs-typeorm` will automatically determine what indexes to create based on the type of data.

TODO: Show the index types

### Queryable or Encrypted?

You can mix and match Queryable and Encrypted.

| Only `@EncryptedColumn` | Just encrypts field in the database |
| `@EncryptedColumn` and `@Queryable` | Encrypts and makes it queryable |
| Only `@Queryable` | Doesn't encrypt the field in the database but creates a queryable index. |

_Why use `@Queryable` without `EncryptedColumn`?_

Adding `@Queryable` to a field that isn't encrypted means that it can be included in queries
that involve one or more encrypted fields.
See below for a deeper explanation.

### Repository Wrapper

`stashjs-typeorm` adds functionality to TypeORM's `Repository` type via `wrapRepo`.

In the demo, we've created a file in `src/repository/UserRepository.ts`:

```typescript
import { wrapRepo } from "@cipherstash/stashjs-typeorm"
import { AppDataSource } from "../data-source"
import { User } from "../entity/User"

// Wraps the TypeORM repo to provide additional magic!
const UserRepository = wrapRepo(AppDataSource.getRepository(User))
export default UserRepository
```

Wrapping a Repo provides 3 new methods:

| Method                   | What it does |
| -------------------------|--------------|
| `createCollection()`     | Create's a CipherStash collection to store the indexes defined by `@Queryable` |
| `dropCollection()`       | Drop's the CipherStash collection for this repo |
| `createCSQueryBuilder()` | Queryable Encryption aware version of TypeORM's `createQueryBuilder` |

### Collection Creation

Before any queries can be run a collection must be created.
This demo does that in the `demoSetup` function before any data is inserted into the database.

Creating a collection is done via the repo:

```typescript
import UserRepository from "./repository/UserRepository"

await UserRepository.createCollection()
```

The collection can be deleted again:

```typescript
import UserRepository from "./repository/UserRepository"

await UserRepository.dropCollection()
```

### Queries

Queries over encrypted fields must use the `createCSQueryBuilder` function on the wrapped repo.
This provides a CipherStash aware query builder so things like `orderBy`, `limit` and `offset` just work.

This also provides a `query` method to perform queries using any `@Queryable` fields.

```typescript
await UserRepository
  .createCSQueryBuilder("user")
  .query(q => q.lastName_match.match("drap"))
  .getMany()
```

The arguments to `query` are the same as for [`stash.js`](https://docs.cipherstash.com/reference/stashjs/index.html)

### Indexing Subscriber

The final part of the demo is the `IndexingSubscriber` which keeps CipherStash indexes updated as data
is changed in the database.

It listens for changes on any model with `@Queryable` fields and indexes the data as required.

The `IndexingSubscriber` is configured in `src/data-source.ts`:

```typescript
import { IndexingSubscriber } from "@cipherstash/stashjs-typeorm"

export const AppDataSource = new DataSource({
  type: "postgres",
  ...
  entities: [User],
  subscribers: [IndexingSubscriber],
})
```
